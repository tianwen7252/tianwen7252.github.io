import{bp as P,bG as M,r as m,cg as ye,ch as Ce,bJ as O,bK as c,bP as ce,ci as ve,cj as Ee,ck as De,cl as ke,bY as Oe,bU as $,bL as Te}from"./vendor-ONl0qZS6.js";import{S as Ae}from"./StickyHeader-u-FBCCY0.js";import{C as H,p as xe,B as Me,D as $e,a as Se,P as we,L as Fe}from"./chartjs-czLD08pJ.js";import{C as U,A as ie,f as de,g as ae,i as ue,j as Re,n as Be,D as se,o as Pe,p as _e,a as Ie}from"./index-G73Dr-ix.js";import{a as q,S as fe,e as ne,E as je,g as S,F as Le,k as ze}from"./antd-CvNDq1s1.js";import"./mathjs-CIvf5Fa-.js";const z={red:"#ff6384",orange:"#ff9f40",yellow:"#ffcd56",green:"#4bc0c0",blue:"#36a2eb",purple:"#9966ff",gray:"#c9cbcf",cinnabar:"#ea4335",palePink:"#f4d8dd",pastelPurple:"#b99fb1",brownSugar:"#b47556",coffee:"#6d4932",gunmetal:"#30313c",armyGreen:"#44501d",coolGrey:"#8898a7",chineseSilver:"#c4d0d2"},T={red:"#ff638480",orange:"#ff9f4080",yellow:"#ffc23380",green:"#4bc0c080",blue:"#37a2eb80",purple:"#9966ff80",gray:"#c9cbcfd9",cinnabar:"#ea433580",palePink:"#f4d8dd80",pastelPurple:"#b99fb180",brownSugar:"#b4755680",coffee:"#6d493280",gunmetal:"#30313c80",armyGreen:"#44501d80",coolGrey:"#8898a780",chineseSilver:"#c4d0d29e"},qe={chineseWhite:"#D5EAE5",columbiaBlue:"#C9DDE7",champagne:"#F4E5CA",palePink:"#F4D8DD",americanSilver:"#CECED0",sunray:"#E9B95E",tealBlue:"#2D6B8E80",skyBlue:"#7BC7EE",pastelYellow:"#F4F497",deepPeach:"#F6C2A6",cottonCandy:"#FBBED6",africanViolet:"#B68EC990",maximumBlueGreen:"#24DAC5",maize:"#F8C058",conditioner:"#FEFFC9",peru:"#C68642"},He={chineseWhite:"#D5EAE5",columbiaBlue:"#C9DDE7",champagne:"#F4E5CA",palePink:"#F4D8DD",americanSilver:"#CECED0",purple:`${U.purple}80`,blue:`${U.blue}80`,gold:`${U.gold}80`,red:`${U.red}80`,skyBlue:"#7BC7EE",cottonCandy:"#FBBED6",africanViolet:"#B68EC990",maximumBlueGreen:"#24DAC5",maize:"#F8C058",conditioner:"#FEFFC9",peru:"#C68642"},re={d:{label:"日",value:"d"},w:{label:"週",value:"w"},m:{label:"月",value:"m"},q:{label:"季",value:"q"},y:{label:"年",value:"y"}},Ye="d|w|m|q|y",Ne={d:["d","w","m"],w:["d","w","m"],m:["w","m","q","y"],q:["m","q","y"],y:["m","q","y"]},Ge=Array.from(Array(10)).map((a,o)=>o+10);function Qe(a){let o="d";return a<=7?o="d":a<=31?o="w":a<=90?o="m":a<=180||a<365?o="q":a>=365&&(o="y"),o}function K(a,o=T){const h=Object.keys(o);return o[h[a%h.length]]}function Ue(a){const o=a instanceof P?a:P.tz(a),h=o.startOf("M").day(),t=o.date()+h;let l=Math.floor(t/7);return t%7!==0&&++l,l}function Y(a,o,h){var s,n,r;const t=Object.keys(a),l=(r=(n=(s=t[0])==null?void 0:s.split)==null?void 0:n.call(s,"/"))==null?void 0:r[0];let f=!0;const i=new Set;let e;return t.forEach((d,u)=>{const b=P.tz(d),[C,A]=d.split("/");let v;switch(o){case"w":{const x=Ue(b);v=`${C}/${A}/W${x}`,i.add(v);break}case"m":v=`${C}/${A}月`,i.add(v);break;case"q":{const x=b.quarter();v=`${C}/Q${x}`,i.add(v);break}case"y":{v=C,i.add(v);break}case"d":default:{v=d;break}}C!==l&&(f=!1),h==null||h({day:b,date:d,group:v},u)}),o==="d"?e=t:e=Array.from(i),{labels:f&&l&&o!=="y"?e.map(d=>d.split("/").slice(1).join("/")):e,dates:t}}const We={id:"totalizer",beforeUpdate:(a,o,h)=>{const t={};let l=0;h.calculate===!0&&a.data.datasets.forEach((f,i)=>{a.isDatasetVisible(i)&&(l=i,f.data.forEach((e,s)=>{t[s]=(t[s]||0)+e}))}),a.$totalizer={totals:t,utmost:l}}};H.register(We);const Ve=M`
  .ant-empty-image {
    height: auto;
    > span {
      background: #efefef2e;
      padding: 40px 0;
      border-radius: 20px;
      width: 100%;
      color: #efefef;
      font-size: 13rem;
    }
  }
`,Je=M`
  font-size: 1.4rem;
  color: #6b6868;
  margin-bottom: 20px;
`,Ke=M`
  justify-content: space-between;
  align-items: baseline;
`,Xe=M`
  width: 100%;
  .ant-empty {
    width: 100%;
  }
`;H.register(xe);H.defaults.plugins.legend.position="bottom";H.defaults.plugins.legend.onClick=(a,o,h)=>{const t=o.datasetIndex,{chart:l}=h,f=l.getDatasetMeta(t).hidden===null?!1:l.getDatasetMeta(t).hidden;l.data.datasets.forEach((i,e)=>{const s=l.getDatasetMeta(e);e!==t?f?s.hidden===null&&(s.hidden=!0):s.hidden=s.hidden===null?!s.hidden:null:e===t&&(s.hidden=null)}),l.update()};H.defaults.layout.padding={top:20};const w=m.memo(({dateMap:a,dateType:o="d",title:h,type:t,style:l,color:f="1",allowedDateType:i=Ye,displayTypes:e="**|doughnut|table",handle:s})=>{const{getAllCommoditiesInfo:n}=m.useContext(ie),[r,d]=m.useState(null),[u=re[o].value,b]=m.useState(),[C,A]=m.useState(t),v=m.useRef(!1),x=t==="doughnut"||t==="pie",N=x?600:"auto",_=m.useMemo(()=>e&&ye(e.trim().replace("**",t).split("|")).map(y=>({label:le(y),value:y})),[t,e]),I=m.useMemo(()=>{switch(f){case"orderTypes":return He;case"2":return qe;case"1":default:return T}},[f]),G=m.useMemo(()=>{switch(t){case"line":return Fe;case"pie":return we;case"bubble":return Se;case"doughnut":return $e;case"bar":default:return Me}},[t]),j=m.useMemo(()=>le(t),[t]),E=m.useMemo(()=>{if(i&&a){const y=i.trim().split("|");return Ce(y.concat(Ne[o]),(D,R,B)=>ke(B,D,R+1)).map(D=>re[D.trim()])}return[]},[a,o,i]),p=m.useCallback(y=>{A(y)},[]),g=m.useCallback(y=>{b(y)},[]);return m.useEffect(()=>{E.length&&!E.some(({value:y})=>y===u)&&(v.current=!0,b(E[0].value))},[E,u]),m.useEffect(()=>{const y=async()=>{const{resMapGroup:k}=await n(),D=await(s==null?void 0:s(a,C,u,I,k));D&&d(D)};!v.current&&y(),v.current=!1},[a,s,u,C,I,n]),O("div",{css:Ve,children:[O(q,{css:Ke,children:[O(fe,{css:Je,children:[j,c("label",{children:h})]}),_&&r&&c(ne,{options:_,value:C,onChange:p}),i?c(ne,{options:E,value:u,onChange:g}):c("div",{style:{width:112}})]}),c(q,{css:Xe,align:x&&"center",style:{height:N,...l},vertical:!0,children:r?c(G,{options:r.options,data:r.data}):c(je,{description:!1,image:j})})]})});function le(a){switch(a){case"line":return c(De,{});case"doughnut":case"pie":return c(Ee,{});case"table":return c(ve,{});case"bar":default:return c(ce,{})}}function Ze(a,o,h){if(!a)return null;const t=[{label:"上午",data:[],backgroundColor:T.yellow,stack:"stack 0"},{label:"下午",data:[],backgroundColor:T.blue,stack:"stack 0"}],l={},f={},i={},{labels:e}=Y(a,h,({date:n,group:r})=>{const{records:d,dailyData:u}=a[n];d.forEach(({total:b,$isAM:C})=>{C?f[r]=(f[r]??0)+b:i[r]=(i[r]??0)+b}),l[r]=(l[r]??0)+u.total}),s=Object.values(l);return t[0].data=Object.values(f),t[1].data=Object.values(i),{options:{responsive:!0,scales:{x:{stacked:!0},y:{stacked:!0}},plugins:{datalabels:{anchor:"end",align:"end",formatter(n,r){const d=s[r.dataIndex];return de(d)},display(n){return n.datasetIndex===1}}}},data:{labels:e,datasets:t}}}function et(a,o,h){if(!a)return null;const t=[{label:"營收",data:[],backgroundColor:T.orange},{label:"成本",data:[],backgroundColor:T.chineseSilver},{label:"淨利",data:[],backgroundColor:T.green}],l={},{labels:f}=Y(a,h,({date:e,group:s})=>{const{records:n,dailyData:r}=a[e];n.forEach(({total:d,$isAM:u})=>{}),l[s]=(l[s]??0)+r.total}),i=Object.values(l);return t[0].data=i,t[1].data=[],t[2].data=i,{options:{responsive:!0,plugins:{datalabels:{anchor:"end",align:"end",formatter(e){return de(e)}}}},data:{labels:f,datasets:t}}}function tt(a,o){if(!a)return null;const h=(e,s)=>e.p0.skip||e.p1.skip?s:void 0,t=(e,s,n)=>(e!=null&&e.p0DataIndex?e.p0DataIndex:e.dataIndex)>=6?s:n,l=[{label:"營業時間",data:[],backgroundColor:e=>t(e,T.blue,T.yellow),borderColor:e=>t(e,z.blue,z.yellow),pointStyle:"circle",pointRadius:10,pointHoverRadius:15,segment:{pointBackgroundColor:e=>t(e,T.blue),pointBorderColor:e=>t(e,z.blue),borderColor:e=>h(e,z.gray)||t(e,z.blue),borderDash:e=>h(e,[6,6])},spanGaps:!0}],f=[...Ge].map(e=>e===14||e===15?`午休 (${ae(e,!0)})`:ae(e,!0));return Object.keys(a).forEach(e=>{const{records:s}=a[e];s.forEach(({createdAt:n})=>{const u=P.tz(n).hour()-10;if(u>-1){const b=l[0].data;b[u]=b[u]??0,++b[u]}})}),l[0].data[4]=NaN,l[0].data[5]=NaN,{options:{responsive:!0,scales:{x:{stacked:!0},y:{stacked:!0}},plugins:{totalizer:{calculate:!0},datalabels:{anchor:"end",align:"end",formatter(e){return`${e} 人`}}},fill:!1,interaction:{intersect:!1},radius:0},data:{labels:f,datasets:l}}}function at(a,o,h,t,l,f){if(!o)return null;const i={},{labels:e}=Y(o,t,({date:n,group:r})=>{const{records:d}=o[n];d.forEach(({data:u})=>{u.forEach(({res:b,type:C})=>{C===a&&(i[b]=i[b]??{},i[b][r]=(i[b][r]??0)+1)})})}),s=f[a].map((n,r)=>({label:n,data:Object.values(i[n]??{}),backgroundColor:K(r,l),stack:"stack 0",datalabels:{formatter(d,u){let b=0;return u.chart.data.datasets.forEach(A=>{b+=A.data[u.dataIndex]??0}),`${(d/b*100).toFixed(1)}%`}}}));return s.push({label:"Total",data:[...Array.from(Array(e.length)).map(()=>0)],datalabels:{align:"end",anchor:"end",formatter(n,r){let d=0;return r.chart.data.datasets.forEach(u=>{d+=u.data[r.dataIndex]??0}),ue(d)}},stack:"stack 0"}),{options:{responsive:!0,scales:{x:{stacked:!0},y:{stacked:!0}},plugins:{tooltip:{callbacks:{label(n){return`${n.dataset.label+": "||""}${n.parsed.y}份`}}}}},data:{labels:e,datasets:s}}}function J(a){return m.useMemo(()=>at.bind(null,a),[a])}function st(a,o,h,t){if(!a)return null;const l={},{labels:f}=Y(a,h,({date:e,group:s})=>{const{records:n}=a[e];n.forEach(({memo:r})=>{r!=null&&r.length&&r.forEach(d=>{l[d]=l[d]??{},l[d][s]=(l[d][s]??0)+1})})}),i=Re.map(({name:e},s)=>({label:e,data:Object.values(l[e]??{}),backgroundColor:K(s,t),stack:"stack 0",datalabels:{formatter(n,r){let d=0;return r.chart.data.datasets.forEach(b=>{d+=b.data[r.dataIndex]??0}),`${(n/d*100).toFixed(1)}%`}}}));return i.push({label:"Total",data:[...Array.from(Array(f.length)).map(()=>0)],backgroundColor:"#7BC7EE",datalabels:{align:"end",anchor:"end",formatter(e,s){let n=0;return s.chart.data.datasets.forEach(r=>{n+=r.data[s.dataIndex]??0}),ue(n)}},stack:"stack 0"}),{options:{indexAxis:"y",responsive:!0,scales:{x:{stacked:!0},y:{stacked:!0}}},data:{labels:f,datasets:i}}}function nt(a,o,h,t,l){if(!a)return null;const f=[],i=[...l["main-dish"]];Y(a,h,({date:s})=>{const{records:n}=a[s];n.forEach(({data:r,memo:d})=>{d!=null&&d.length&&!d.includes("外送")||r.forEach(({res:u,type:b})=>{if(b==="main-dish"){const C=i.indexOf(u);C>-1&&(f[C]=(f[C]??0)+1)}})})});const e=[{data:f,backgroundColor:i.map((s,n)=>K(n,t)),datalabels:{formatter(s){if(s===void 0)return"";const n=f.reduce((d,u)=>d+u,0),r=(s/n*100).toFixed(1);return`${s}份 (${r}%)`}}}];return{options:{responsive:!0,plugins:{tooltip:{callbacks:{label(s){return`${s.parsed}份`}}}}},data:{labels:i,datasets:e}}}const rt=M`
  padding: 20px;
  padding-bottom: 80px;
`,lt=M`
  margin-bottom: 20px;
  font-size: 1.4rem;
  color: #6b6868;
  padding: 10px 20px;

  .ant-picker {
    margin-left: 30px;
    margin-right: 20px;
  }
`,ot=M`
  vertical-align: middle;
`,ct=M`
  .ant-flex {
    margin-bottom: 20px;
    justify-content: space-around;
  }

  .ant-statistic {
    text-align: center;
  }

  .ant-statistic-title {
    color: #858585;
    font-size: 1.1rem;
    border-bottom: 1px solid #d3cdcd;
    padding-bottom: 4px;
  }
`,F=M`
  ${Be({rtColor:"#FBD28E",rbColor:"#B2E9E6",lbColor:"#FCD5C2",ltColor:"#FFBBBA"})}
`,{RangePicker:it}=ze,oe={},dt=m.memo(()=>{const{API:a}=m.useContext(ie),o=P.tz(),h=o.format(se),[t,l]=m.useState(()=>[o.startOf("day"),o.endOf("day")]),[f,i]=m.useState("今天"),[e,s,n]=m.useMemo(()=>{if(!(t!=null&&t.length))return[null,null,void 0];const p=t.map(k=>k.valueOf()),g=Math.abs(t[0].diff(t[1],"day")),y=Qe(g);return[...p,y]},[t]),r=m.useMemo(()=>{const p=o.startOf("day"),g=o.endOf("day"),y=p.add(-1,"d"),k=p.quarter()>2;return[{label:"今天",value:[p,g]},{label:"昨天",value:[y,y.endOf("day")]},{label:"2天內",value:[y,g]},{label:"本週",value:[p.day(1),g]},{label:"上週",value:[p.add(-7,"d").day(1),g.add(-7,"d").day(5)]},{label:"2週內",value:[p.add(-14,"d").day(1),g]},{label:"本月",value:[p.startOf("M"),g]},{label:"上個月",value:[p.add(-1,"M").startOf("M"),g.add(-1,"M").endOf("M")]},{label:"2月內",value:[p.add(-1,"M").startOf("M"),g]},{label:"本季",value:[p.startOf("Q"),g]},{label:"上季",value:[p.add(-1,"Q").startOf("Q"),g.add(-1,"Q").endOf("Q")]},{label:"上半年",value:[p.startOf("y"),p.month(5).endOf("M")]},k?{label:"下半年",value:[p.month(6).startOf("M"),g.endOf("y")]}:null,{label:"今年",value:[p.startOf("y"),g.endOf("y")]},{label:"去年",value:[p.add(-1,"y").startOf("y"),g.add(-1,"y").endOf("y")]},{label:"2年內",value:[p.add(-1,"y"),g]}].filter(D=>D)},[h]),d=m.useCallback(p=>{if(p){const[g,y]=p;r.some(({label:D,value:R})=>{const B=R[0].valueOf()===g.valueOf()&&R[1].valueOf()===y.valueOf();return B&&i(D),B})||i(""),l(p)}},[r]),{records:u,dailyDataInfo:b}=Oe(async()=>!e||!s?oe:await a.statistics.get(e,s),[e,s],oe),C=m.useMemo(()=>{if(!u||!b)return{incomeTotal:null,incomeAMTotal:null,incomePMTotal:null,recordsCount:null,resCount:null,mainDishCount:null,profits:null,cost:null,dateMap:null};const p={};let g=0,y=0,k=0,D=0,R=0,B=0,pe=0;return b.forEach(L=>{const{date:Q,total:W}=L;g+=W,p[Q]=p[Q]??{records:[],dailyData:L}}),u.forEach(L=>{const{createdAt:Q,data:W,total:X}=L,V=P.tz(Q),be=V.format(se),Z=Pe(V.hour(),V.minute())==="AM";Z?y+=X:k+=X,W.forEach(({res:he,type:me,amount:ge})=>{const te=_e(ge);he&&(me==="main-dish"&&(R+=te),D+=te)});const ee=L;ee.$isAM=Z,p[be].records.push(ee)}),{incomeTotal:g,incomeAMTotal:y,incomePMTotal:k,resCount:D,mainDishCount:R,profits:B,cost:pe,recordsCount:(u==null?void 0:u.length)??0,dateMap:p}},[u,b]),{incomeTotal:A,profits:v,cost:x,recordsCount:N,incomeAMTotal:_,incomePMTotal:I,resCount:G,mainDishCount:j,dateMap:E}=C;return O(Te,{children:[O(Ae,{cls:lt,children:[O(fe,{css:ot,children:[c(ce,{}),c("label",{children:"統計報表"})]}),c(it,{showNow:!0,inputReadOnly:!0,presets:r,format:Ie,placeholder:["開始日期","結束日期"],size:"large",value:t,onChange:d}),c("label",{children:f&&`(${f})`})]}),O(q,{css:rt,vertical:!0,gap:40,children:[O("div",{css:ct,children:[O(q,{children:[c("div",{css:F,children:c(S,{title:"總營業額 (含修正)",prefix:$(A)?"":"$",value:A??"---"})}),c("div",{css:F,children:c(S,{title:"淨利",prefix:$(v)?"":"$",value:v??"---"})}),c("div",{css:F,children:c(S,{title:"成本",prefix:$(x)?"":"$",value:x??"---"})}),c("div",{css:F,children:c(S,{title:"訂單數量",prefix:$(N)?"":"$",value:N??"---"})})]}),O(q,{children:[c("div",{css:F,children:c(S,{title:"上午營業額",prefix:$(_)?"":"$",value:_??"---"})}),c("div",{css:F,children:c(S,{title:"下午營業額",prefix:$(I)?"":"$",value:I??"---"})}),c("div",{css:F,children:c(S,{title:"銷售便當數量",prefix:$(j)?"":"$",value:j??"---"})}),c("div",{css:F,children:c(S,{title:"銷售商品數量",prefix:$(G)?"":"$",value:G??"---"})})]})]}),c(w,{type:"bar",title:"營收分析",dateMap:E,dateType:n,handle:Ze}),c(w,{type:"bar",title:"淨利分析",dateMap:E,dateType:n,handle:et}),c(w,{type:"line",title:"客流量分析 (總計)",dateMap:E,dateType:n,allowedDateType:null,handle:tt}),c(w,{type:"bar",title:"便當銷售分析",dateMap:E,dateType:n,handle:J("main-dish")}),c(w,{type:"bar",title:"單點銷售分析",dateMap:E,dateType:n,color:"2",handle:J("à-la-carte")}),c(w,{type:"bar",title:"零售銷售分析",dateMap:E,dateType:n,handle:J("others")}),c(w,{type:"bar",title:"訂單備註分析",dateMap:E,dateType:n,color:"orderTypes",handle:st}),c(w,{type:"doughnut",title:"送外訂單分析",dateMap:E,dateType:n,allowedDateType:null,handle:nt}),c(Le.BackTop,{visibilityHeight:100})]})]})}),gt=dt;export{dt as Component,gt as Statistics,gt as default};

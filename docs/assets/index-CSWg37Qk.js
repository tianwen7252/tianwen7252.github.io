var Pe=Object.defineProperty;var Le=(o,e,t)=>e in o?Pe(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var q=(o,e,t)=>Le(o,typeof e!="symbol"?e+"":e,t);import{g as S,A as de,r as re,a as r,j as v,F as Q,L as ze,M as je,x as Fe,N as He,y as Se}from"./index-D6OYzFC2.js";import{r as d,R as Ve}from"./react-DQrQyBkK.js";import{S as Je}from"./StickyHeader-KX7zxFTT.js";import{x as pe,M as ve,I as Z,V as ee,B as D,o as me,k as Ae,F as Ye,m as Ke,z as $,W as ye,X as ge,p as be,Y as Ee,Z as ne,$ as L,y as z,a0 as j,b as Ge,a1 as Xe,S as we,g as We,a2 as Qe,a3 as Ze,a4 as et,a5 as tt}from"./antd-CsVyReHd.js";import{d as ae,c as ke,s as ot,g as st}from"./lodash-EY-pETZd.js";import"./mathjs-FsHcr6tf.js";const le={product:{}},rt={storage:le,updateStorage:()=>{},setInitialStorage:o=>{}},De=d.createContext(rt),nt=S`
  padding: 20px;
`,ie=S`
  margin-bottom: 20px;
`,at=S`
  float: right;
`;S`
  margin-bottom: 16px;
`;S`
  width: 100%;
  margin-bottom: 16px;
`;S`
  width: 100%;
  margin-bottom: 16px;
`;const it=S`
  margin-bottom: 40px;
  .ant-table-thead > tr > th {
    background: #f1fafe;
  }
`,Te=S`
  margin-top: 20px;
  margin-bottom: 30px;

  .ant-table-thead > tr > th {
    background: #f0f9f3;
  }
`,ct=S`
  margin-top: 20px;
  margin-bottom: 20px;

  .ant-table-thead > tr > th {
    background: #fef4cb66;
  }
`,K=S`
  margin-right: 10px;
`,xe=S`
  margin-left: 10px;
`,lt=S`
  margin-top: 40px;
  padding: 20px;
`,G=o=>{var t;const e=o.closest(".ant-table-row");return Array.from(((t=e==null?void 0:e.parentElement)==null?void 0:t.childNodes)??[]).indexOf(e)},ut=()=>{const{API:o}=d.useContext(de),{storage:e,updateStorage:t,setInitialStorage:s}=d.useContext(De),[n,i]=d.useState(""),[l,p]=pe.useNotification(),[f,m]=ve.useModal(),[_,M]=d.useReducer(y=>!y,!0),F=d.useRef("1");d.useLayoutEffect(()=>{if(n){const[y,b,h]=n.split(":");setTimeout(()=>{var a,u,T,x;const c=document.getElementById(y).querySelectorAll(".ant-table-tbody > tr");if(c.length&&c[h]){const g=c[h];g.childNodes.forEach(w=>{w.classList.remove("ant-table-cell-row-hover")}),b==="up"?(u=(a=g==null?void 0:g.previousSibling)==null?void 0:a.childNodes)==null||u.forEach(w=>{w.classList.add("ant-table-cell-row-hover")}):(x=(T=g==null?void 0:g.nextSibling)==null?void 0:T.childNodes)==null||x.forEach(w=>{w.classList.add("ant-table-cell-row-hover")})}},100)}},[n]);const C=d.useCallback((y=!1)=>{y&&M(),t()},[t]),E=re(async()=>{const y=await o.commondityTypes.get();return e.product.commondityTypes=y,s("product.commondityTypes"),y.map(b=>({key:b.id,...b}))},[],[]),U=d.useCallback(ae((y,b)=>{e.product.commondityTypes.some(h=>h.id===y?(h.label=b.target.value,C(),!0):!1)},300),[C]),k=d.useMemo(()=>[{title:"編號",dataIndex:"typeID",key:"typeID"},{title:"種類",dataIndex:"label",key:"label",render:(y,b)=>r(Z,{defaultValue:b.label,style:{width:200},onChange:U.bind(null,b.id)},b.id)}],[U]),I=re(async()=>{const y=await o.commondity.get();e.product.commondities=y,s("product.commondities")},[],[]),R=d.useCallback(ae((y,b,h,c)=>{const{commondities:a}=e.product,u=a.find(x=>x.id===y),{typeID:T}=u;if(u){const x=c==null?void 0:c.target,g="resta-settings-commondity-tabs";switch(b){case"edit":{const w=(x==null?void 0:x.value)??c;u[h]=w,C();break}case"delete":{u.id.toString().includes("new-")?e.product.commondities=a.filter(w=>w.id!==y):u.onMarket="0",C(!0);break}case"moveUp":{const w=a.find(P=>P.priority===u.priority-1&&P.typeID===T);if(w){++w.priority,--u.priority;const P=G(x);C(!0),i(`${g}:up:${P}`)}break}case"moveDown":{const w=a.find(P=>P.priority===u.priority+1&&P.typeID===T);if(w){--w.priority,++u.priority;const P=G(x);C(!0),i(`${g}:down:${P}`)}break}}}},150),[]),A=d.useMemo(()=>{var h;const y=[{title:"順序",dataIndex:"priority",key:"priority"},{title:"品名",dataIndex:"name",key:"name",render:(c,a)=>r(Z,{defaultValue:a.name,onChange:R.bind(null,a.id,"edit","name")},a.id)},{title:"價格",dataIndex:"price",key:"price",render:(c,a)=>r(Ke,{type:"number",defaultValue:a.price,onChange:R.bind(null,a.id,"edit","price")},a.id)},{title:"鍵盤顯示",dataIndex:"hideOnMode",key:"hideOnMode",render:(c,a)=>v($,{defaultValue:a.hideOnMode||"",style:{width:140},onChange:u=>R(a.id,"edit","hideOnMode",u),children:[r($.Option,{value:"",children:"皆顯示"}),r($.Option,{value:"calculator",children:"僅顯示在計算機"}),r($.Option,{value:"commondity",children:"僅顯示在商品"}),r($.Option,{value:"both",children:"皆不顯示"})]})},{title:"設定",key:"action",render:(c,a)=>v(Q,{children:[r(D,{css:K,type:"text",variant:"filled",color:"primary",icon:r(ye,{}),onClick:R.bind(null,a.id,"moveUp",null)}),r(D,{css:K,type:"text",variant:"filled",color:"primary",icon:r(ge,{}),onClick:R.bind(null,a.id,"moveDown",null)}),r(D,{css:xe,type:"text",variant:"filled",color:"danger",icon:r(be,{}),onClick:R.bind(null,a.id,"delete",null)})]})}],b={};return(h=e.product.commondities)==null||h.forEach(c=>{const{id:a,typeID:u,priority:T,onMarket:x}=c;b[u]=b[u]??[],x==="1"&&b[u].push({key:`${a}-${T}`,...c})}),(E==null?void 0:E.map(c=>{const{id:a,label:u,typeID:T}=c,x=b[T]??[];return x.sort((g,w)=>g.priority-w.priority),{key:a,label:u,children:r(ee,{bordered:!1,css:Te,dataSource:x,columns:y,pagination:!1})}}))??[]},[E,R,I,_]),N=d.useCallback(()=>{var c,a;const y=F.current,{commondities:b}=e.product,h=b.filter(u=>u.typeID===y&&u.onMarket!=="0").sort((u,T)=>u.priority-T.priority);if(h){const u=h.at(-1).priority+1;b.push({hideOnMode:"",id:`new-${Date.now()}`,name:"",onMarket:"1",price:0,priority:u,editor:"admin",typeID:y}),C(!0),window.scroll({top:((a=(c=document.getElementById("resta-settings-commondity-tabs"))==null?void 0:c.getBoundingClientRect())==null?void 0:a.bottom)-document.body.getBoundingClientRect().top-150,left:0,behavior:"smooth"})}},[e.product,C]),B=re(async()=>{const y=await o.orderTypes.get();e.product.orderTypes=y,s("product.orderTypes")},[],[]),O=d.useCallback(ae((y,b,h,c)=>{const{orderTypes:a}=e.product,u=a.find(T=>T.id===y);if(u){const T=c==null?void 0:c.target,x="resta-settings-orderTypes-table";switch(b){case"edit":{const g=(T==null?void 0:T.value)??c;u[h]=g,C();break}case"delete":{e.product.orderTypes=a.filter(g=>g.id!==y),C(!0);break}case"moveUp":{const g=a.find(w=>w.priority===u.priority-1);if(g){++g.priority,--u.priority;const w=G(T);C(!0),i(`${x}:up:${w}`)}break}case"moveDown":{const g=a.find(w=>w.priority===u.priority+1);if(g){--g.priority,++u.priority;const w=G(T);C(!0),i(`${x}:down:${w}`)}break}}}},150),[]),[H,oe]=d.useMemo(()=>{var h;const y=[{title:"順序",dataIndex:"priority",key:"priority"},{title:"名稱",dataIndex:"name",key:"name",render:(c,a)=>r(Z,{defaultValue:a.name,onChange:O.bind(null,a.id,"edit","name")},a.id)},{title:"顏色",dataIndex:"color",key:"color",render:(c,a)=>v($,{defaultValue:a.color??"",style:{width:120},onChange:u=>O(a.id,"edit","color",u),children:[r($.Option,{value:"",children:"無"}),r($.Option,{value:"red",children:"紅色"}),r($.Option,{value:"blue",children:"藍色"}),r($.Option,{value:"purple",children:"紫色"}),r($.Option,{value:"gold",children:"金色"}),r($.Option,{value:"brown",children:"咖啡色"})]},a.id)},{title:"設定",key:"action",render:(c,a)=>v(Q,{children:[r(D,{css:K,type:"text",variant:"filled",color:"primary",icon:r(ye,{}),onClick:O.bind(null,a.id,"moveUp",null)}),r(D,{css:K,type:"text",variant:"filled",color:"primary",icon:r(ge,{}),onClick:O.bind(null,a.id,"moveDown",null)}),r(D,{css:xe,type:"text",variant:"filled",color:"danger",icon:r(be,{}),onClick:O.bind(null,a.id,"delete",null)})]})}],b=((h=e.product.orderTypes)==null?void 0:h.map(c=>({...c,key:c.id})).sort((c,a)=>c.priority-a.priority))??[];return[y,b]},[B,O,_]),se=d.useCallback(()=>{var h,c;const{orderTypes:y}=e.product;if(y.length>=10){l.warning({message:"系統設定",description:"訂單分類最多只能10個",showProgress:!0});return}const b=y.sort((a,u)=>a.priority-u.priority);if(b){const a=b.at(-1).priority+1;y.push({id:`new-${Date.now()}`,name:"",priority:a,editor:"admin",type:"order"}),C(!0),window.scroll({top:((c=(h=document.getElementById("resta-settings-orderTypes-table"))==null?void 0:h.getBoundingClientRect())==null?void 0:c.bottom)-document.body.getBoundingClientRect().top-100,left:0,behavior:"smooth"})}},[e.product,l,C]),Y=d.useCallback(y=>{F.current=y},[]);return v("div",{css:nt,children:[p,m,r("h2",{css:ie,children:"商品種類"}),r(ee,{bordered:!1,css:it,dataSource:E,columns:k,pagination:!1}),r("h2",{css:ie,children:"商品設定"}),r(Ae,{id:"resta-settings-commondity-tabs",items:A,css:Te,tabBarExtraContent:r(D,{icon:r(me,{}),onClick:N,children:"新增商品"}),onChange:Y}),v("h2",{css:ie,children:["訂單分類",r(D,{css:at,icon:r(me,{}),onClick:se,children:"新增分類"})]}),r(ee,{id:"resta-settings-orderTypes-table",css:ct,bordered:!1,dataSource:oe,columns:H,pagination:!1}),r(D,{css:lt,type:"primary",danger:!0,block:!0,onClick:d.useCallback(()=>{f.confirm({title:"危險動作 - 請再次確認",content:v(Q,{children:[r("label",{children:"確定要還原所有商品和分類到預設狀態嗎？此操作無法復原。"}),v("h4",{children:["預設資料的最後更新日期為：",ze]})]}),okText:"確認還原",cancelText:"取消",okType:"danger",width:500,onOk:()=>{o.reset(),setTimeout(()=>{l.success({message:"系統設定",description:"資料已還原成功，即將重新啟動App...",showProgress:!0,duration:3})},100),setTimeout(()=>{window.location.reload()},3e3)}})},[f,o,l]),children:"還原預設"}),r(Ye.BackTop,{visibilityHeight:100})]})};class Ce extends Error{constructor(t,s,n){const i=t.status||t.status===0?t.status:"",l=t.statusText||"",p=`${i} ${l}`.trim(),f=p?`status code ${p}`:"an unknown error";super(`Request failed with ${f}: ${s.method} ${s.url}`);q(this,"response");q(this,"request");q(this,"options");this.name="HTTPError",this.response=t,this.request=s,this.options=n}}class Be extends Error{constructor(t){super(`Request timed out: ${t.method} ${t.url}`);q(this,"request");this.name="TimeoutError",this.request=t}}const V=o=>o!==null&&typeof o=="object",X=(...o)=>{for(const e of o)if((!V(e)||Array.isArray(e))&&e!==void 0)throw new TypeError("The `options` argument must be an object");return he({},...o)},$e=(o={},e={})=>{const t=new globalThis.Headers(o),s=e instanceof globalThis.Headers,n=new globalThis.Headers(e);for(const[i,l]of n.entries())s&&l==="undefined"||l===void 0?t.delete(i):t.set(i,l);return t};function W(o,e,t){return Object.hasOwn(e,t)&&e[t]===void 0?[]:he(o[t]??[],e[t]??[])}const Me=(o={},e={})=>({beforeRequest:W(o,e,"beforeRequest"),beforeRetry:W(o,e,"beforeRetry"),afterResponse:W(o,e,"afterResponse"),beforeError:W(o,e,"beforeError")}),he=(...o)=>{let e={},t={},s={};for(const n of o)if(Array.isArray(n))Array.isArray(e)||(e=[]),e=[...e,...n];else if(V(n)){for(let[i,l]of Object.entries(n))V(l)&&i in e&&(l=he(e[i],l)),e={...e,[i]:l};V(n.hooks)&&(s=Me(s,n.hooks),e.hooks=s),V(n.headers)&&(t=$e(t,n.headers),e.headers=t)}return e},dt=(()=>{let o=!1,e=!1;const t=typeof globalThis.ReadableStream=="function",s=typeof globalThis.Request=="function";if(t&&s)try{e=new globalThis.Request("https://empty.invalid",{body:new globalThis.ReadableStream,method:"POST",get duplex(){return o=!0,"half"}}).headers.has("Content-Type")}catch(n){if(n instanceof Error&&n.message==="unsupported BodyInit type")return!1;throw n}return o&&!e})(),pt=typeof globalThis.AbortController=="function",ht=typeof globalThis.ReadableStream=="function",ft=typeof globalThis.FormData=="function",Oe=["get","post","put","patch","head","delete"],mt={json:"application/json",text:"text/*",formData:"multipart/form-data",arrayBuffer:"*/*",blob:"*/*"},ce=2147483647,qe=Symbol("stop"),yt={json:!0,parseJson:!0,stringifyJson:!0,searchParams:!0,prefixUrl:!0,retry:!0,timeout:!0,hooks:!0,throwHttpErrors:!0,onDownloadProgress:!0,fetch:!0},gt={method:!0,headers:!0,body:!0,mode:!0,credentials:!0,cache:!0,redirect:!0,referrer:!0,referrerPolicy:!0,integrity:!0,keepalive:!0,signal:!0,window:!0,dispatcher:!0,duplex:!0,priority:!0},bt=o=>Oe.includes(o)?o.toUpperCase():o,wt=["get","put","head","delete","options","trace"],kt=[408,413,429,500,502,503,504],Tt=[413,429,503],_e={limit:2,methods:wt,statusCodes:kt,afterStatusCodes:Tt,maxRetryAfter:Number.POSITIVE_INFINITY,backoffLimit:Number.POSITIVE_INFINITY,delay:o=>.3*2**(o-1)*1e3},xt=(o={})=>{if(typeof o=="number")return{..._e,limit:o};if(o.methods&&!Array.isArray(o.methods))throw new Error("retry.methods must be an array");if(o.statusCodes&&!Array.isArray(o.statusCodes))throw new Error("retry.statusCodes must be an array");return{..._e,...o}};async function Ct(o,e,t,s){return new Promise((n,i)=>{const l=setTimeout(()=>{t&&t.abort(),i(new Be(o))},s.timeout);s.fetch(o,e).then(n).catch(i).then(()=>{clearTimeout(l)})})}async function _t(o,{signal:e}){return new Promise((t,s)=>{e&&(e.throwIfAborted(),e.addEventListener("abort",n,{once:!0}));function n(){clearTimeout(i),s(e.reason)}const i=setTimeout(()=>{e==null||e.removeEventListener("abort",n),t()},o)})}const Rt=(o,e)=>{const t={};for(const s in e)!(s in gt)&&!(s in yt)&&!(s in o)&&(t[s]=e[s]);return t};class te{constructor(e,t={}){q(this,"request");q(this,"abortController");q(this,"_retryCount",0);q(this,"_input");q(this,"_options");var s,n;if(this._input=e,this._options={...t,headers:$e(this._input.headers,t.headers),hooks:Me({beforeRequest:[],beforeRetry:[],beforeError:[],afterResponse:[]},t.hooks),method:bt(t.method??this._input.method),prefixUrl:String(t.prefixUrl||""),retry:xt(t.retry),throwHttpErrors:t.throwHttpErrors!==!1,timeout:t.timeout??1e4,fetch:t.fetch??globalThis.fetch.bind(globalThis)},typeof this._input!="string"&&!(this._input instanceof URL||this._input instanceof globalThis.Request))throw new TypeError("`input` must be a string, URL, or Request");if(this._options.prefixUrl&&typeof this._input=="string"){if(this._input.startsWith("/"))throw new Error("`input` must not begin with a slash when using `prefixUrl`");this._options.prefixUrl.endsWith("/")||(this._options.prefixUrl+="/"),this._input=this._options.prefixUrl+this._input}if(pt){this.abortController=new globalThis.AbortController;const i=this._options.signal??this._input.signal;i!=null&&i.aborted&&this.abortController.abort(i==null?void 0:i.reason),i==null||i.addEventListener("abort",()=>{this.abortController.abort(i.reason)}),this._options.signal=this.abortController.signal}if(dt&&(this._options.duplex="half"),this._options.json!==void 0&&(this._options.body=((n=(s=this._options).stringifyJson)==null?void 0:n.call(s,this._options.json))??JSON.stringify(this._options.json),this._options.headers.set("content-type",this._options.headers.get("content-type")??"application/json")),this.request=new globalThis.Request(this._input,this._options),this._options.searchParams){const l="?"+(typeof this._options.searchParams=="string"?this._options.searchParams.replace(/^\?/,""):new URLSearchParams(this._options.searchParams).toString()),p=this.request.url.replace(/(?:\?.*?)?(?=#|$)/,l);(ft&&this._options.body instanceof globalThis.FormData||this._options.body instanceof URLSearchParams)&&!(this._options.headers&&this._options.headers["content-type"])&&this.request.headers.delete("content-type"),this.request=new globalThis.Request(new globalThis.Request(p,{...this.request}),this._options)}}static create(e,t){const s=new te(e,t),n=async()=>{if(typeof s._options.timeout=="number"&&s._options.timeout>ce)throw new RangeError(`The \`timeout\` option cannot be greater than ${ce}`);await Promise.resolve();let p=await s._fetch();for(const f of s._options.hooks.afterResponse){const m=await f(s.request,s._options,s._decorateResponse(p.clone()));m instanceof globalThis.Response&&(p=m)}if(s._decorateResponse(p),!p.ok&&s._options.throwHttpErrors){let f=new Ce(p,s.request,s._options);for(const m of s._options.hooks.beforeError)f=await m(f);throw f}if(s._options.onDownloadProgress){if(typeof s._options.onDownloadProgress!="function")throw new TypeError("The `onDownloadProgress` option must be a function");if(!ht)throw new Error("Streams are not supported in your environment. `ReadableStream` is missing.");return s._stream(p.clone(),s._options.onDownloadProgress)}return p},l=s._options.retry.methods.includes(s.request.method.toLowerCase())?s._retry(n):n();for(const[p,f]of Object.entries(mt))l[p]=async()=>{s.request.headers.set("accept",s.request.headers.get("accept")||f);const m=await l;if(p==="json"){if(m.status===204||(await m.clone().arrayBuffer()).byteLength===0)return"";if(t.parseJson)return t.parseJson(await m.text())}return m[p]()};return l}_calculateRetryDelay(e){if(this._retryCount++,this._retryCount>this._options.retry.limit||e instanceof Be)throw e;if(e instanceof Ce){if(!this._options.retry.statusCodes.includes(e.response.status))throw e;const s=e.response.headers.get("Retry-After")??e.response.headers.get("RateLimit-Reset")??e.response.headers.get("X-RateLimit-Reset")??e.response.headers.get("X-Rate-Limit-Reset");if(s&&this._options.retry.afterStatusCodes.includes(e.response.status)){let n=Number(s)*1e3;Number.isNaN(n)?n=Date.parse(s)-Date.now():n>=Date.parse("2024-01-01")&&(n-=Date.now());const i=this._options.retry.maxRetryAfter??n;return n<i?n:i}if(e.response.status===413)throw e}const t=this._options.retry.delay(this._retryCount);return Math.min(this._options.retry.backoffLimit,t)}_decorateResponse(e){return this._options.parseJson&&(e.json=async()=>this._options.parseJson(await e.text())),e}async _retry(e){try{return await e()}catch(t){const s=Math.min(this._calculateRetryDelay(t),ce);if(this._retryCount<1)throw t;await _t(s,{signal:this._options.signal});for(const n of this._options.hooks.beforeRetry)if(await n({request:this.request,options:this._options,error:t,retryCount:this._retryCount})===qe)return;return this._retry(e)}}async _fetch(){for(const s of this._options.hooks.beforeRequest){const n=await s(this.request,this._options);if(n instanceof Request){this.request=n;break}if(n instanceof Response)return n}const e=Rt(this.request,this._options),t=this.request;return this.request=t.clone(),this._options.timeout===!1?this._options.fetch(t,e):Ct(t,e,this.abortController,this._options)}_stream(e,t){const s=Number(e.headers.get("content-length"))||0;let n=0;return e.status===204?(t&&t({percent:1,totalBytes:s,transferredBytes:n},new Uint8Array),new globalThis.Response(null,{status:e.status,statusText:e.statusText,headers:e.headers})):new globalThis.Response(new globalThis.ReadableStream({async start(i){const l=e.body.getReader();t&&t({percent:0,transferredBytes:0,totalBytes:s},new Uint8Array);async function p(){const{done:f,value:m}=await l.read();if(f){i.close();return}if(t){n+=m.byteLength;const _=s===0?0:n/s;t({percent:_,transferredBytes:n,totalBytes:s},m)}i.enqueue(m),await p()}await p()}}),{status:e.status,statusText:e.statusText,headers:e.headers})}}/*! MIT License © Sindre Sorhus */const ue=o=>{const e=(t,s)=>te.create(t,X(o,s));for(const t of Oe)e[t]=(s,n)=>te.create(s,X(o,n,{method:t}));return e.create=t=>ue(X(t)),e.extend=t=>(typeof t=="function"&&(t=t(o??{})),ue(X(o,t))),e.stop=qe,e},It=ue();var Ue={exports:{}},St=d;function Ne(o,e,t){var s=typeof e=="function";St.useEffect(function(){var n,i=!0,l=o(function(){return i});return Promise.resolve(l).then(function(p){n=p}),function(){i=!1,s&&e(n)}},s?t:e)}Ue.exports=Ne;var vt=Ue.exports.useAsyncEffect=Ne;const Re="0.0.24",At=S`
  .ant-card-bordered {
    border: 1px solid #ddd;
    background-image: linear-gradient(
      to right bottom,
      #ffffff,
      #fff,
      #fff,
      #fff,
      #f5f5f5
    );
  }
  .ant-statistic .ant-statistic-title {
    font-size: 0.9rem;
    color: #777;
  }
`,Ie=o=>Number(o==null?void 0:o.replaceAll(".","")),Et=Ve.memo(()=>{const[o,e]=pe.useNotification(),[t,s]=d.useState("---"),[{useage:n,percentageUsed:i,remaining:l},p]=d.useState({useage:"---",percentageUsed:"---",remaining:"---"});let f=!1;return Ie(t)>Ie(Re)&&(f=!0),vt(async()=>{try{const m=await It.get(je).json();if(m!=null&&m.start_url){const _=m.start_url.match(/v=(.+)/);_&&s(_[1])}}catch(m){m!=null&&m.message&&o.error({message:"網路資料錯誤",description:`取得最新版本失敗: ${m.message}`,duration:20,showProgress:!0})}try{const{useage:m,percentageUsed:_,remaining:M}=await Fe();p({useage:m,percentageUsed:_,remaining:M})}catch{}},[o]),v("div",{css:At,children:[e,f&&r(Ee,{style:{margin:"12px 0"},message:"請重開App將自動更新到最新版本",type:"warning",showIcon:!0}),v(ne,{gutter:12,children:[r(j,{span:8,children:r(L,{children:r(z,{title:"本機App版本",prefix:"v",value:Re})})}),r(j,{span:8,children:r(L,{children:r(z,{title:"程式資料庫同步版本",value:He})})}),r(j,{span:8,children:r(L,{children:r(z,{title:"本機資料庫同步版本",value:localStorage.getItem("SYNC_NUMBER")})})})]}),v(ne,{gutter:12,style:{marginTop:12},children:[r(j,{span:8,children:r(L,{children:r(z,{title:"最新App版本",prefix:"v",value:t})})}),r(j,{span:8,children:r(L,{children:r(z,{title:"雲端資料同步版本",value:"---"})})}),r(j,{span:8,children:r(L,{children:r(z,{title:"本機雲端資料同步版本",value:localStorage.getItem("CLOUD_SYNC_NUMBER")??"---"})})})]}),v(ne,{gutter:12,style:{marginTop:12},children:[r(j,{span:8,children:r(L,{children:r(z,{title:"本機資料庫使用量",value:n})})}),r(j,{span:8,children:r(L,{children:r(z,{title:"本機資料庫剩餘量",value:l})})}),r(j,{span:8,children:r(L,{children:r(z,{title:"本機資料庫使用率",value:i})})})]})]})}),Dt="https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable",fe="https://www.googleapis.com/drive/v3/files";function J(){return`backup-${Ge.tz().format("YYYY-MM-DD_HH-mm-ss")}.json`}async function Bt(){return new Promise((o,e)=>{const t=indexedDB.open(Se);t.onsuccess=async s=>{const n=s.target.result,i=n.transaction(n.objectStoreNames,"readonly"),l={};let p=n.objectStoreNames.length;for(const f of n.objectStoreNames){const _=i.objectStore(f).getAll();_.onsuccess=()=>{l[f]=_.result,--p===0&&o(new Blob([JSON.stringify(l)],{type:"application/json"}))},_.onerror=e}},t.onerror=e})}async function $t(o,e,t){const s=await fetch(Dt,{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json; charset=UTF-8","X-Upload-Content-Length":e.toString(),"X-Upload-Content-Type":"application/json"},body:JSON.stringify({name:t,parents:["1uYgRpQWjFOgfmZ_QaAm5elMHVMp0_lb-"]})});if(!s.ok)throw new Error("Failed to initialize resumable upload");return s.headers.get("Location")}async function Mt(o,e,t,s){const n=await $t(o,e.size,t),i=262144;let l=0;for(;l<e.size;){const p=e.slice(l,l+i),f=await fetch(n,{method:"PUT",headers:{Authorization:`Bearer ${o}`,"Content-Length":p.size.toString(),"Content-Range":`bytes ${l}-${l+p.size-1}/${e.size}`},body:p});if(f.status===308)l+=p.size,s(Math.floor(l/e.size*100));else{if(f.ok)return s(100),await f.json();throw new Error(`Upload failed with status ${f.status}`)}}}async function Ot(o){const e=await fetch(`${fe}?pageSize=5&orderBy=createdTime desc&fields=files(id,name,size,createdTime)`,{headers:{Authorization:`Bearer ${o}`}}),t=await e.json();if(!e.ok)throw t;const s=(t==null?void 0:t.files)??[];return s.forEach(n=>{n.size=qt(n.size)}),s}function qt(o){return o<1024?`${o} B`:o<1024*1024?`${(o/1024).toFixed(2)} KB`:`${(o/1024/1024).toFixed(2)} MB`}async function Ut(o,e){for(const t of e)await fetch(`${fe}/${t}`,{method:"DELETE",headers:{Authorization:`Bearer ${o}`}})}async function Nt(o,e,t){const s=await Bt(),n=t&&t.trim().length>0?t.trim():J();return await Mt(o,s,n,e)}async function Pt(o,e){const t=await fetch(`${fe}/${e}?alt=media`,{headers:{Authorization:`Bearer ${o}`}});if(!t.ok)throw new Error("Failed to download backup");return await t.json()}async function Lt(o){return await new Promise((e,t)=>{const s=indexedDB.open(Se);s.onerror=()=>t(s.error),s.onsuccess=n=>{const i=n.target.result,l=Array.from(i.objectStoreNames),p=i.transaction(l,"readwrite");p.oncomplete=()=>{i.close(),e()},p.onerror=()=>{i.close(),t(p.error)},l.forEach(f=>{const m=p.objectStore(f);m.clear(),(o[f]??[]).forEach(M=>{m.put(M)})})}})}async function zt(o,e){const t=await Pt(o,e);await Lt(t)}const jt=S`
  margin-top: 10px;
`,Ft="799987452297-qetqo8blfushga2h064of13epeqtgh4a",Ht=()=>{const{gAPIToken:o,setGAPIToken:e}=d.useContext(de),[t,s]=d.useState([]),[n,i]=d.useState(0),[l,p]=d.useState(!1),[f,m]=d.useState([]),[_,M]=d.useState(null),[F,C]=d.useState(!1),[E,U]=d.useState(()=>J()),[k,I]=pe.useNotification(),R=d.useRef(!1),A=d.useCallback(async h=>{var a,u,T,x;const c=h??o;if(c)try{const g=await Ot(c);s(g)}catch(g){((T=(u=(a=g==null?void 0:g.error)==null?void 0:a.errors)==null?void 0:u[0])==null?void 0:T.message)==="Invalid Credentials"?N(!0):k.error({message:"無法載入備份資料",description:String(((x=g==null?void 0:g.error)==null?void 0:x.message)??"API Response Error")})}},[o,k]),N=d.useCallback((h=!1)=>{var u,T;if(!h&&o)return;const c=(T=(u=window.google)==null?void 0:u.accounts)==null?void 0:T.oauth2;if(!c){k.error({message:"Google OAuth 尚未載入，請稍後再試"});return}c.initTokenClient({client_id:`${Ft}.apps.googleusercontent.com`,scope:"https://www.googleapis.com/auth/drive.file",callback:x=>{const g=x==null?void 0:x.access_token;if(!g){k.error({message:"未取得授權 Token，請重試"});return}e(g),A(g)}}).requestAccessToken()},[o,A,k,e]);d.useEffect(()=>{o?A(o):N()},[o,A,N]);const B=d.useCallback(()=>o||(k.info({message:"請先授權 Google Drive 帳戶"}),N(),null),[o,k,N]),O=d.useCallback(()=>{B()&&(U(J()),C(!0),R.current=!1)},[B]),H=d.useCallback(()=>{C(!1),R.current=!1},[]),oe=d.useCallback(async()=>{const h=B();if(!h)return;const a=E.trim()||J();C(!1),R.current=!1,p(!0);try{await Nt(h,u=>i(u),a),k.success({message:"備份成功"}),U(J()),await A(h)}catch(u){k.error({message:"備份失敗",description:String(u)})}finally{p(!1),i(0)}},[E,B,A,k]),se=d.useCallback(async()=>{const h=B();if(h){p(!0);try{await Ut(h,f),k.success({message:"檔案刪除成功!"}),A(h)}catch(c){k.error({message:"無法刪除檔案",description:String(c)})}finally{p(!1),m([])}}},[B,A,k,f]),Y=d.useCallback(async h=>{const c=B();if(c){M(h),p(!0);try{await zt(c,h),k.success({message:"備份資料庫還原成功!"})}catch(a){k.error({message:"無法還原備份資料庫",description:String(a)})}finally{M(null),p(!1)}}},[B,k]),y=d.useMemo(()=>[{title:"備份名稱",dataIndex:"name",key:"name"},{title:"大小 (bytes)",dataIndex:"size",key:"size"},{title:"建立時間",dataIndex:"createdTime",key:"createdTime"},{title:"動作",key:"action",render:(h,c)=>r(D,{type:"default",onClick:()=>Y(c.id),loading:_===c.id,children:"還原此資料庫"})}],[Y,_]),b=d.useCallback(h=>{h&&!R.current&&setTimeout(()=>{h.focus({cursor:"all"}),R.current=!0},100)},[]);return v(Q,{children:[I,r(ve,{title:"設定備份檔名",open:F,onOk:oe,onCancel:H,okText:"開始備份",cancelText:"取消",children:r(Z,{value:E,onChange:h=>U(h.target.value),placeholder:"輸入備份檔名",ref:b})}),r(D,{type:"primary",onClick:O,loading:l,children:"建立備份"}),n>0&&r(Xe,{percent:n,status:"active",strokeColor:{from:"#108ee9",to:"#87d068"}}),r(ee,{rowSelection:{selectedRowKeys:f,onChange:m},dataSource:t,columns:y,rowKey:"id",pagination:!1,style:{marginTop:16}}),f.length>0&&r(D,{danger:!0,onClick:se,loading:l,css:jt,children:"刪除"})]})},Vt=S`
  margin-bottom: 20px;
  font-size: 1.4rem;
  color: #6b6868;
  padding: 10px 20px;
`,Jt=S`
  vertical-align: middle;
`,Yt=S`
  padding-bottom: 80px;
  h2 {
    font-weight: normal;
    color: #6b6868;
    font-size: 1.3rem;
    border-left: 6px solid #6b686891;
    border-radius: 4px;
    padding-left: 8px;
  }
  .ant-tabs .ant-tabs-tab {
    font-size: 1rem;
  }
`,Kt=S`
  padding: 0 20px;
`,Gt=S`
  padding: 4px 8px;
  margin-left: 20px;
`,Xt=S`
  float: right;
  right: 60px;
  padding: 14px 8px;
  top: 5px;
  font-size: 1rem;
`,Wt=[{key:"info",icon:r(Qe,{}),label:"系統資訊",children:r(Et,{})},{key:"product",icon:r(Ze,{}),label:"商品設定",children:r(ut,{})},{key:"cost",icon:r(et,{}),label:"每月成本"},{key:"backup",icon:r(tt,{}),label:"雲端備份",children:r(Ht,{})}],no=()=>{const{API:o}=d.useContext(de),e=d.useMemo(()=>({...le}),[]),t=d.useMemo(()=>ke(le),[]),[s,n]=d.useState(!1),i=d.useCallback(()=>{console.log("comparison",e,t),n(JSON.stringify(e)!==JSON.stringify(t))},[e,t]),l=d.useCallback(()=>{let f=!1;const{product:{commondityTypes:m,commondities:_,orderTypes:M}}=e;m.forEach((I,R)=>{t.product.commondityTypes[R].label!==I.label&&(o.commondityTypes.set(I.id,I),f=!0)});const F=t.product.commondities,C=[],E=[],U=[],k=new Map(F.map(I=>[I.id.toString(),I]));console.log("source & iDMap",_,Array.from(k)),_.forEach(I=>{const R=I.id.toString(),A=k.get(R);if(R.includes("new-"))C.push(I),k.delete(R);else if(k.has(R)){const{name:N,price:B,priority:O,onMarket:H}=I;N!==A.name||B!==A.price?(C.push(I),E.push(I)):H==="0"?E.push(I):O!==A.priority&&U.push(I),k.delete(R)}});for(const[,I]of k)E.push(I);console.log("result",{newList:C,deletedList:E,updatedList:U}),f&&n(!1)},[e,t,i,o]),p=d.useMemo(()=>({storage:e,updateStorage:i,setInitialStorage:f=>{ot(t,f,ke(st(e,f))),console.log("init",f,e,t)}}),[e,t,i]);return r(De.Provider,{value:p,children:v("div",{css:Yt,children:[v(Je,{cls:Vt,children:[v(we,{css:Jt,children:[r(We,{}),r("label",{children:"系統設定"}),s&&r(we,{children:r(Ee,{css:Gt,description:"設定尚未存檔",type:"warning",showIcon:!0})})]}),s&&r(D,{css:Xt,size:"small",type:"primary",onClick:l,children:"存檔設定 (測式中-未完成)"})]}),r("div",{css:Kt,children:r(Ae,{items:Wt,defaultActiveKey:"info",destroyInactiveTabPane:!0})})]})})};export{no as Component,no as Settings,no as default};
